#!/bin/bash
HOST_FILE_PATH=$1
NGPU_PER_NODE=$2
NUM_NODES=$3
SINGLE_RUN=$4 # True or False
export NGPU=$((NGPU_PER_NODE*NUM_NODES))
export MASTER_PORT=$((NGPU+12345))

echo "HOST_FILE_PATH=$HOST_FILE_PATH"
echo "NGPU_PER_NODE=$NGPU_PER_NODE"
echo "NUM_NODES=$NUM_NODES"
echo "NGPU=$NGPU"
echo "MASTER_PORT=$MASTER_PORT"
echo "SINGLE_RUN=$SINGLE_RUN"

if [ "$SINGLE_RUN" = "True" ]; then
    # single run test
    deepspeed --master_port $MASTER_PORT --hostfile $HOST_FILE_PATH --num_nodes ${NUM_NODES} --num_gpus ${NGPU} \
    trainer.py gpt2 \
    --learning-rate 5e-4

else
    # recursive run
    lrs=(5e-4, 1e-4)
    widths=(16 32 64 128)

    for lr in "${lrs[@]}"; do
        for width in "${widths[@]}"; do
            run_name="lr_${lr}"
            deepspeed --master_port $MASTER_PORT --hostfile $HOST_FILE_PATH --num_nodes ${NUM_NODES} --num_gpus ${NGPU} \
            run_trainer.py \
            --learning-rate $lr \
            --run_name $run_name
        done
    done
fi